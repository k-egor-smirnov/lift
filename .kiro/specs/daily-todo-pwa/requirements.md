# Requirements Document

## Introduction

Данное PWA приложение представляет собой систему управления задачами с уникальной концепцией ежедневного сброса и трехуровневой категоризацией. Основная особенность - фокус на задачах текущего дня с возможностью детального логирования прогресса работы. Приложение построено на React с local-first подходом, использует архитектуру Vertical Slice + Layered с MVVM на презентационном слое. Каждая фича изолирована, но использует общие доменные абстракции. Поддерживает облачную синхронизацию через адаптеры с возможностью замены провайдера.

## Glossary

**День (Day Boundary)**: Граница дня определяется как 00:00 в локальном часовом поясе пользователя.

**Overdue**: Задача в категории Inbox считается просроченной, если `currentDate - inboxEnteredAt >= inboxOverdueDays` (по умолчанию 3 дня).

**Inbox Review (Разобрана)**: Задача считается разобранной при первом перемещении из категории INBOX в любую другую категорию (SIMPLE или FOCUS).

**DailySelection**: Отдельная проекция, содержащая связи между задачами и конкретным днем. Создается новая запись для каждого дня, предыдущие сохраняются как история.

**Типы логов**:

- SYSTEM: Автоматически генерируемые системой (создание, смена категории, завершение, конфликт, просрочка)
- USER: Пользовательские логи к задачам
- CONFLICT: Логи разрешения конфликтов синхронизации

**Стратегия синхронизации**: Last-Write-Wins (LWW) по полю `updatedAt` с автоматическим созданием системного лога при обнаружении конфликта.

**Временные метки**: Все временные метки хранятся в UTC, преобразование в локальный часовой пояс происходит при отображении.

**Политика retention логов**: Приоритетный порядок удаления - сначала USER логи старше 180 дней, затем самые старые USER логи если превышен лимит 50 на задачу, SYSTEM логи удаляются только при превышении общего лимита.

**Настройки синхронизации**: Пользовательские настройки синхронизируются между устройствами и хранятся per user.

## Requirements

### Requirement 1

**User Story:** Как пользователь, я хочу управлять задачами в трех категориях (Простые, Фокусные, Инбокс), чтобы эффективно организовать свою работу по уровню сложности и важности.

#### Acceptance Criteria

1. WHEN пользователь создает новую задачу THEN система SHALL предоставить выбор из трех категорий: Простые, Фокусные, Инбокс
2. WHEN пользователь просматривает список задач THEN система SHALL отображать задачи сгруппированными по категориям
3. WHEN пользователь перемещает задачу между категориями THEN система SHALL обновить категорию задачи и создать системный лог о перемещении
4. IF задача находится в категории "Простые" THEN система SHALL отображать соответствующую визуальную индикацию для быстрых задач
5. IF задача находится в категории "Фокусные" THEN система SHALL отображать соответствующую визуальную индикацию для важных задач
6. IF задача находится в категории "Инбокс" THEN система SHALL отображать соответствующую визуальную индикацию для задач на разбор
7. WHEN задача в Инбоксе не разбирается N дней THEN система SHALL подсвечивать задачу как просроченную
8. WHEN есть неразобранные задачи в Инбоксе THEN система SHALL отображать счетчик в меню категории с усиливающейся визуальной индикацией
9. WHEN количество дней неразобранных задач настраивается THEN система SHALL позволить пользователю изменить этот параметр

### Requirement 2

**User Story:** Как пользователь, я хочу выбирать задачи на сегодня из общих списков, чтобы сфокусироваться на актуальных задачах текущего дня.

#### Acceptance Criteria

1. WHEN пользователь нажимает на иконку солнца у задачи THEN система SHALL добавить задачу в список "Сегодня"
2. WHEN пользователь открывает главный экран THEN система SHALL отображать только задачи, выбранные на сегодня
3. WHEN пользователь убирает задачу из списка "Сегодня" THEN система SHALL вернуть задачу в соответствующую категорию
4. WHEN наступает новый день THEN система SHALL переключиться на новую DailySelection, сохранив предыдущую как историю
5. IF задача выполнена в списке "Сегодня" THEN система SHALL отметить задачу как завершенную и создать системный лог

### Requirement 3

**User Story:** Как пользователь, я хочу вести логи прогресса по каждой задаче, чтобы отслеживать свою работу и быстро входить в контекст.

#### Acceptance Criteria

1. WHEN пользователь добавляет лог к задаче THEN система SHALL сохранить лог с временной меткой
2. WHEN пользователь просматривает список задач THEN система SHALL отображать последний лог каждой задачи
3. WHEN пользователь нажимает на задачу с логами THEN система SHALL показать полную историю логов этой задачи
4. WHEN происходят важные изменения задачи THEN система SHALL автоматически создать системный лог
5. WHEN пользователь создает кастомный лог THEN система SHALL сохранить лог без привязки к конкретной задаче
6. IF у задачи нет логов THEN система SHALL отображать стандартное сообщение или пустое состояние

### Requirement 4

**User Story:** Как пользователь, я хочу видеть мотивационное окно в начале дня с незавершенными задачами, чтобы планировать свой рабочий день.

#### Acceptance Criteria

1. WHEN пользователь открывает приложение в начале нового рабочего дня THEN система SHALL показать модальное окно с обзором дня
2. WHEN отображается модальное окно THEN система SHALL показать список незавершенных задач с предыдущего дня
3. WHEN отображается модальное окно THEN система SHALL показать неразобранные задачи из Инбокса
4. WHEN отображается модальное окно THEN система SHALL показать мотивационное сообщение
5. WHEN пользователь закрывает модальное окно THEN система SHALL запомнить, что окно было показано для текущего дня
6. IF нет незавершенных задач с предыдущего дня THEN система SHALL показать только мотивационное сообщение
7. IF пользователь уже видел окно сегодня THEN система SHALL не показывать окно повторно

### Requirement 5

**User Story:** Как пользователь, я хочу использовать приложение на мобильных и десктопных устройствах, чтобы иметь доступ к задачам в любое время.

#### Acceptance Criteria

1. WHEN пользователь открывает приложение на мобильном устройстве THEN система SHALL отображать адаптивный интерфейс для мобильных экранов
2. WHEN пользователь открывает приложение на десктопе THEN система SHALL отображать интерфейс, оптимизированный для больших экранов
3. WHEN пользователь устанавливает PWA THEN система SHALL работать в автономном режиме с базовой функциональностью
4. WHEN пользователь использует сенсорные жесты THEN система SHALL корректно обрабатывать touch-события
5. IF устройство поддерживает push-уведомления THEN система SHALL предложить их включить

### Requirement 6

**User Story:** Как пользователь, я хочу синхронизировать свои данные между устройствами, чтобы иметь актуальную информацию везде.

#### Acceptance Criteria

1. WHEN пользователь создает или изменяет задачу THEN система SHALL синхронизировать изменения через Supabase
2. WHEN пользователь работает офлайн THEN система SHALL сохранять изменения локально
3. WHEN соединение восстанавливается THEN система SHALL синхронизировать локальные изменения с сервером
4. WHEN происходит конфликт данных THEN система SHALL применить стратегию разрешения конфликтов
5. IF синхронизация недоступна THEN система SHALL уведомить пользователя о работе в автономном режиме
6. WHEN пользователь входит в систему на новом устройстве THEN система SHALL загрузить все его данные

### Requirement 7

**User Story:** Как пользователь, я хочу использовать горячие клавиши для быстрого выполнения основных действий, чтобы повысить эффективность работы.

#### Acceptance Criteria

1. WHEN пользователь нажимает горячую клавишу для создания задачи THEN система SHALL открыть форму создания новой задачи
2. WHEN пользователь нажимает горячие клавиши для навигации THEN система SHALL переключиться между категориями
3. WHEN пользователь нажимает горячую клавишу для лога THEN система SHALL открыть форму добавления кастомного лога
4. WHEN пользователь находится в форме THEN система SHALL поддерживать стандартные горячие клавиши (Escape для отмены, Enter для сохранения)
5. IF пользователь на мобильном устройстве THEN система SHALL скрыть горячие клавиши или адаптировать их под touch-интерфейс

### Requirement 8

**User Story:** Как пользователь, я хочу видеть детальную статистику выполненных задач с правильными формулами расчета, чтобы точно отслеживать свою продуктивность.

#### Acceptance Criteria

1. WHEN пользователь завершает задачу THEN система SHALL зафиксировать статистику для категории на момент завершения (без последующих изменений при смене категории)
2. WHEN система рассчитывает статистику "разобранных" задач THEN система SHALL считать задачи при первом перемещении из INBOX в любую другую категорию
3. WHEN система показывает недельную статистику THEN система SHALL использовать ISO неделю (понедельник-воскресенье)
4. WHEN система показывает месячную статистику THEN система SHALL использовать календарный месяц (1-е число до последнего дня)
5. WHEN пользователь просматривает статистику THEN система SHALL показать данные за разные периоды (день, неделя, месяц)
6. WHEN выполняется soft delete задачи THEN система SHALL сохранить историческую статистику без изменений

### Requirement 9

**User Story:** Как разработчик, я хочу иметь архитектуру Vertical Slice + Layered с чистым доменом, чтобы код был поддерживаемым и расширяемым.

#### Acceptance Criteria

1. WHEN создается новая фича THEN система SHALL изолировать ее в отдельном vertical slice (tasks, today, logs, stats, onboarding)
2. WHEN создается компонент презентационного слоя THEN система SHALL следовать MVVM: View (React JSX) ↔ ViewModel (state orchestration) ↔ Use Cases
3. WHEN создается доменная логика THEN система SHALL размещать бизнес-правила в сущностях, Value Objects, Domain Services и Policies
4. WHEN происходят доменные события THEN система SHALL использовать Domain Events для логов, статистики и триггеров синхронизации
5. IF компонент содержит fetch/UI логику THEN система SHALL запретить размещение такой логики в домене
6. WHEN тестируется функциональность THEN система SHALL позволить изолированное тестирование каждого слоя

### Requirement 10

**User Story:** Как разработчик, я хочу иметь local-first архитектуру с адаптерами синхронизации, чтобы обеспечить надежность и гибкость.

#### Acceptance Criteria

1. WHEN данные сохраняются THEN система SHALL использовать локальный репозиторий (IndexedDB) как источник истины
2. WHEN происходит синхронизация THEN система SHALL использовать синк-движок для адаптации к провайдеру (Supabase)
3. WHEN требуется замена провайдера THEN система SHALL позволить замену через адаптер без изменения бизнес-логики
4. WHEN приложение работает офлайн THEN система SHALL обеспечить полную функциональность через локальное хранилище
5. IF происходит конфликт данных THEN система SHALL разрешить конфликт на уровне синк-движка
6. WHEN данные изменяются локально THEN система SHALL немедленно обновить UI без ожидания синхронизации

### Requirement 11

**User Story:** Как пользователь, я хочу выполнять полный CRUD операций с задачами, чтобы эффективно управлять своим списком дел.

#### Acceptance Criteria

1. WHEN пользователь создает задачу THEN система SHALL сохранить задачу с заголовком, категорией, временными метками и создать системный лог
2. WHEN пользователь просматривает задачи THEN система SHALL отображать все активные задачи с их текущим статусом
3. WHEN пользователь редактирует заголовок задачи THEN система SHALL обновить заголовок и создать системный лог об изменении
4. WHEN пользователь изменяет категорию задачи THEN система SHALL обновить категорию и создать системный лог
5. WHEN пользователь завершает задачу THEN система SHALL отметить задачу как выполненную, зафиксировать статистику для текущей категории и создать системный лог
6. WHEN пользователь отменяет завершение задачи THEN система SHALL вернуть задачу в активное состояние и пересчитать статистику
7. WHEN пользователь удаляет задачу THEN система SHALL выполнить soft delete и сохранить связь в DailySelection для исторического просмотра
8. IF задача находится в списке "Сегодня" при обновлениях title/category/status THEN система SHALL сохранить связь в DailySelection

### Requirement 12

**User Story:** Как пользователь, я хочу иметь надежную систему логирования с ограничениями, чтобы отслеживать историю без переполнения хранилища.

#### Acceptance Criteria

1. WHEN создается системный лог THEN система SHALL автоматически генерировать логи для: создания задачи, смены категории, завершения, конфликта синхронизации, просрочки Inbox
2. WHEN пользователь вводит лог THEN система SHALL ограничить длину сообщения до 500 символов
3. WHEN система хранит логи THEN система SHALL применять политику хранения: максимум 180 дней или топ 50 логов на задачу
4. WHEN пользователь просматривает историю логов THEN система SHALL использовать пагинацию по 20 записей на страницу
5. WHEN происходит конфликт синхронизации THEN система SHALL создать лог типа CONFLICT с деталями разрешения
6. IF лимиты превышены THEN система SHALL удалять самые старые логи, сохраняя системные логи приоритетнее пользовательских

### Requirement 13

**User Story:** Как пользователь, я хочу иметь быстрый отклик интерфейса и надежную работу в офлайне, чтобы эффективно работать в любых условиях.

#### Acceptance Criteria

1. WHEN пользователь выполняет локальную операцию THEN система SHALL обновить UI менее чем за 50ms (p95)
2. WHEN приложение работает офлайн THEN система SHALL показать баннер о статусе подключения
3. WHEN пользователь работает офлайн THEN система SHALL сохранять все изменения в локальную очередь синхронизации
4. WHEN соединение восстанавливается THEN система SHALL автоматически синхронизировать очередь изменений в фоне
5. WHEN происходит синхронизация THEN система SHALL не блокировать пользовательский интерфейс
6. IF операция синхронизации не удалась THEN система SHALL повторить попытку с экспоненциальной задержкой

### Requirement 14

**User Story:** Как пользователь, я хочу иметь настройки по умолчанию и персонализацию, чтобы приложение работало оптимально для моих потребностей.

#### Acceptance Criteria

1. WHEN приложение запускается впервые THEN система SHALL установить inboxOverdueDays = 3 дня по умолчанию
2. WHEN приложение запускается впервые THEN система SHALL включить горячие клавиши по умолчанию для десктопа
3. WHEN определяется время показа мотивационного окна THEN система SHALL показывать окно при первом запуске после 06:00-11:00
4. WHEN пользователь изменяет настройки THEN система SHALL сохранить персональные предпочтения локально
5. WHEN пользователь сбрасывает настройки THEN система SHALL вернуть все значения к заводским умолчаниям
6. IF пользователь на мобильном устройстве THEN система SHALL отключить горячие клавиши по умолчанию

### Requirement 15

**User Story:** Как разработчик, я хочу использовать ежедневную проекцию для списка "Сегодня", чтобы упростить управление и сохранить историю.

#### Acceptance Criteria

1. WHEN создается список "Сегодня" THEN система SHALL использовать отдельную проекцию DailySelection вместо флага в Task
2. WHEN наступает новый день THEN система SHALL создать новую DailySelection и сохранить предыдущую как историю
3. WHEN задача добавляется в "Сегодня" THEN система SHALL создать связь в DailySelection без изменения самой задачи
4. WHEN происходит ежедневный сброс THEN система SHALL просто переключиться на новую DailySelection
5. IF нужна история выбора задач THEN система SHALL предоставить доступ к предыдущим DailySelection
6. WHEN задача удаляется из "Сегодня" THEN система SHALL удалить только связь в DailySelection
