# План улучшений модального окна нового дня

## Анализ текущего состояния

Текущая реализация модального окна нового дня имеет следующие компоненты:
- `OnboardingService` - бизнес-логика для агрегации данных
- `OnboardingViewModel` - состояние и управление модальным окном  
- `DailyModal` - UI компонент
- `useDailyModal` - хук для управления жизненным циклом
- `DailyModalContainer` - контейнер для управления жизненным циклом

## Выявленные проблемы и требования

### 1. Обработка смены дня в фоне
**Проблема**: Если приложение находится в фоне и наступает новый день, пользователь может не увидеть модальное окно нового дня.

**Требования из requirements.md**:
- Requirement 4: Показ модального окна в начале нового дня с незавершенными задачами
- Requirement 14: Показ модального окна в утреннее время (6-11 AM)
- Requirement 4: Запоминание показа окна на текущий день

### 2. Отсутствие кнопки "Добавить в Сегодня" для просроченных задач
**Проблема**: В текущей реализации есть кнопка "Вернуть в Сегодня" для всех задач, но нужна специальная логика для добавления просроченных задач из инбокса в DailySelection.

**Требования из requirements.md**:
- Requirement 4: Отображение неразобранных задач из Инбокса
- Requirement 14: Использование настройки `inboxOverdueDays`
- Requirement 2: Возврат задач в категорию при удалении из "Сегодня"

### 3. Недостаточная интеграция с DailySelection
**Проблема**: Модальное окно не полностью интегрировано с системой DailySelection для добавления задач.

**Требования из requirements.md**:
- Requirement 2: DailySelection как основа для списка "Сегодня"
- Requirement 15: Использование отдельной проекции DailySelection
- Requirement 2: Переключение на новую DailySelection в начале дня

### 4. Отсутствие системного логирования
**Проблема**: Действия пользователя в модальном окне не логируются.

**Требования из requirements.md**:
- Requirement 3: Система логирования с временными метками
- Requirement 12: Автоматическая генерация системных логов
- Requirement 3: Автоматическое создание системных логов

### 5. Проблемы с временными зонами и переходом дня
**Проблема**: Логика определения нового дня может работать некорректно при смене часовых поясов или в полночь.

**Требования из requirements.md**:
- Requirement 4: Переключение на новую DailySelection в начале дня
- Requirement 14: Показ в утреннее время (6-11 AM)

## Задачи для выполнения

### [ ] 1. Обработка смены дня в фоне
**Проблема**: Приложение не отслеживает смену дня когда находится в фоне.

**Решение**:
- Добавить слушатель события `visibilitychange` в useDailyModal
- При возврате проверять, не сменился ли день через новый метод `checkDayTransition()`
- Сбрасывать состояние `modalShownToday` если день сменился
- Перезагружать данные модального окна и показывать его при необходимости

### [ ] 2. Интеграция с DailySelection для добавления задач
**Проблема**: Модальное окно не использует DailySelection для добавления задач в "Сегодня".

**Решение**:
- Создать DailySelectionService для управления задачами "Сегодня"
- Обновить OnboardingService для интеграции с DailySelection
- Добавить методы для добавления задач в текущую DailySelection
- Обеспечить создание новой DailySelection при смене дня

### [ ] 3. Улучшение UI для добавления задач в "Сегодня"
**Проблема**: Нужно улучшить UX для добавления просроченных задач из инбокса.

**Решение**:
- Обновить интерфейс `DailyModalProps` для добавления `onAddTaskToToday`
- Изменить кнопки для просроченных задач: "Добавить в Сегодня" вместо "Вернуть в Сегодня"
- Добавить визуальное различие между незавершенными и просроченными задачами
- Улучшить иконки и текст кнопок для лучшего UX

### [ ] 4. Рефакторинг OnboardingViewModel для отслеживания дня
**Проблема**: Текущий ViewModel не отслеживает смену дня в runtime.

**Решение**:
- Добавить поле `currentDay` в состояние для отслеживания текущего дня
- Добавить метод `checkDayTransition()` для проверки смены дня
- Обновить логику `wasModalShownToday()` для учета смены дня
- Добавить метод `resetForNewDay()` для сброса состояния при смене дня

### [ ] 5. Системное логирование действий
**Проблема**: Отсутствует логирование действий пользователя в модальном окне.

**Решение**:
- Интегрировать LoggingService в OnboardingService
- Добавить логи для показа модального окна ("Daily modal shown")
- Добавить логи для действий пользователя:
  - "Task added to today from daily modal"
  - "Daily modal closed"
  - "Daily modal dismissed"
- Включить информацию о количестве задач в логах

### [ ] 6. Улучшение обработки времени и часовых поясов
**Проблема**: Логика времени может работать некорректно в edge cases.

**Решение**:
- Улучшить логику `isInMorningWindow()` с использованием локального времени
- Добавить более надежную проверку смены дня с учетом часовых поясов
- Обработать случаи перехода через полночь
- Использовать DateOnly для консистентного определения дня

### [ ] 7. Обновление useDailyModal хука
**Проблема**: Хук не обрабатывает смену дня и возврат из фона.

**Решение**:
- Добавить слушатель `visibilitychange` для отслеживания возврата в приложение
- Добавить периодическую проверку смены дня (каждые 30 секунд при активном приложении)
- Интегрировать с новыми методами ViewModel для проверки смены дня
- Обеспечить автоматический показ модального окна при смене дня

### [ ] 8. Тестирование новой функциональности
**Проблема**: Нужно протестировать все улучшения.

**Решение**:
- Тест обработки смены дня в фоне (симуляция через DevDayTransition)
- Тест добавления просроченных задач в "Сегодня"
- Тест повторного показа модального окна после смены дня
- Тест edge cases (полночь, переход через часовые пояса)
- Тест системного логирования
- Тест интеграции с DailySelection

## Порядок выполнения

1. **Рефакторинг OnboardingViewModel** - добавить отслеживание смены дня (задача 4)
2. **Создание DailySelectionService** - сервис для управления задачами "Сегодня" (задача 2)
3. **Обновление OnboardingService** - интеграция с DailySelection и логирование (задачи 2, 5)
4. **Обновление useDailyModal** - обработка смены дня и возврата в приложение (задачи 1, 7)
5. **Обновление UI компонентов** - улучшение UX для добавления задач (задача 3)
6. **Улучшение обработки времени** - более надежная логика времени (задача 6)
7. **Тестирование** - проверить все сценарии (задача 8)

---

## Прогресс выполнения

- [ ] Задача 1: Обработка смены дня в фоне
- [ ] Задача 2: Интеграция с DailySelection для добавления задач
- [ ] Задача 3: Улучшение UI для добавления задач в "Сегодня"
- [ ] Задача 4: Рефакторинг OnboardingViewModel для отслеживания дня
- [ ] Задача 5: Системное логирование действий
- [ ] Задача 6: Улучшение обработки времени и часовых поясов
- [ ] Задача 7: Обновление useDailyModal хука
- [ ] Задача 8: Тестирование новой функциональности

## Примечания

- Все изменения должны соответствовать архитектуре Vertical Slice + Layered
- Бизнес-логика должна оставаться в доменном слое
- UI логика должна быть в презентационном слое
- Использовать существующие паттерны и конвенции кода